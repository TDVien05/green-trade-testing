


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > OrderController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">Green_trade.green_trade_platform.controller</a>
</div>

<h1>Coverage Summary for Class: OrderController (Green_trade.green_trade_platform.controller)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">OrderController</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/69)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package Green_trade.green_trade_platform.controller;
&nbsp;
&nbsp;import Green_trade.green_trade_platform.enumerate.SystemWalletStatus;
&nbsp;import Green_trade.green_trade_platform.exception.OrderNotFound;
&nbsp;import Green_trade.green_trade_platform.mapper.*;
&nbsp;import Green_trade.green_trade_platform.model.*;
&nbsp;import Green_trade.green_trade_platform.request.CancelOrderRequest;
&nbsp;import Green_trade.green_trade_platform.request.ReviewRequest;
&nbsp;import Green_trade.green_trade_platform.response.*;
&nbsp;import Green_trade.green_trade_platform.service.implement.*;
&nbsp;import io.swagger.v3.oas.annotations.Operation;
&nbsp;import lombok.AllArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.http.MediaType;
&nbsp;import org.springframework.http.ResponseEntity;
&nbsp;import org.springframework.security.access.prepost.PreAuthorize;
&nbsp;import org.springframework.web.bind.annotation.*;
&nbsp;import org.springframework.web.multipart.MultipartFile;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;
&nbsp;@RestController
&nbsp;@RequestMapping(&quot;/api/v1/order&quot;)
<b class="nc">&nbsp;@Slf4j</b>
&nbsp;@AllArgsConstructor
&nbsp;public class OrderController {
&nbsp;
&nbsp;    private final OrderServiceImpl orderService;
&nbsp;    private final ResponseMapper responseMapper;
&nbsp;    private final OrderListMapper orderListMapper;
&nbsp;    private final BuyerServiceImpl buyerService;
&nbsp;    private final GhnServiceImpl ghnService;
&nbsp;    private final OrderMapper orderMapper;
&nbsp;    private final ReviewServiceImpl reviewService;
&nbsp;    private final ReviewMapper reviewMapper;
&nbsp;    private final SystemWalletServiceImpl systemWalletService;
&nbsp;    private final ShippingPartnerMapper shippingPartnerMapper;
&nbsp;    private final PaymentMapper paymentMapper;
&nbsp;    private final PostProductMapper postProductMapper;
&nbsp;    private final BuyerMapper buyerMapper;
&nbsp;    private final OrderHistoryMapper orderHistoryMapper;
&nbsp;    private final OrderHistoryListMapper orderHistoryListMapper;
&nbsp;
&nbsp;    @Operation(
&nbsp;            summary = &quot;Get order history of current user&quot;,
&nbsp;            description = &quot;&quot;&quot;
&nbsp;                        Retrieves a paginated list of past orders belonging to the currently authenticated buyer.  
&nbsp;                        The system uses the access token to identify the buyer and fetches their order history, 
&nbsp;                        including details such as order ID, total amount, status, and order date.
&nbsp;                    
&nbsp;                        **Workflow:**
&nbsp;                        1. The frontend sends a request with pagination parameters (`page`, `size`).
&nbsp;                        2. The backend identifies the buyer from the JWT token.
&nbsp;                        3. The system retrieves a paginated list of the buyer’s orders, sorted by date (latest first).
&nbsp;                        4. Pagination metadata (current page, total pages, total elements) is included in the response.
&nbsp;                    
&nbsp;                        **Use cases:**
&nbsp;                        - Displaying a user’s order history in their profile dashboard.
&nbsp;                        - Fetching paginated order records for mobile or web apps.
&nbsp;                    
&nbsp;                        **Security Notes:**
&nbsp;                        - Requires authentication via JWT (`ROLE_BUYER`).
&nbsp;                        - Each user can only access their own order history.
&nbsp;                    &quot;&quot;&quot;
&nbsp;    )
&nbsp;    @PreAuthorize(&quot;hasAnyRole(&#39;ROLE_BUYER&#39;, &#39;ROLE_SELLER&#39;)&quot;)
&nbsp;    @GetMapping(&quot;/history&quot;)
&nbsp;    public ResponseEntity&lt;RestResponse&lt;OrderHistoryListResponse, Object&gt;&gt; getOrdersHistoryOfCurrentUser(
&nbsp;            @RequestParam(name = &quot;page&quot;, defaultValue = &quot;0&quot;) int page,
&nbsp;            @RequestParam(name = &quot;size&quot;, defaultValue = &quot;10&quot;) int size
&nbsp;    ) {
&nbsp;        try {
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; [OrderController] came history&quot;);</b>
<b class="nc">&nbsp;            Buyer buyer = buyerService.getCurrentUser();</b>
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; [OrderController] get current buyer successfully&quot;);</b>
<b class="nc">&nbsp;            Page&lt;Order&gt; orderPaging = orderService.getOrdersOfCurrentUserPaging(size, page, buyer);</b>
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; [OrderController] get paging with order successfully&quot;);</b>
<b class="nc">&nbsp;            Map&lt;String, Object&gt; meta = Map.of(</b>
<b class="nc">&nbsp;                    &quot;currentPage&quot;, orderPaging.getNumber(),</b>
<b class="nc">&nbsp;                    &quot;totalElements&quot;, orderPaging.getTotalElements(),</b>
<b class="nc">&nbsp;                    &quot;totalPage&quot;, orderPaging.getTotalPages()</b>
&nbsp;            );
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; [OrderController] created meta data successfully&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            OrderHistoryListResponse orderHistoryListResponse = orderHistoryListMapper.toDto(orderPaging, meta);</b>
&nbsp;
&nbsp;
<b class="nc">&nbsp;            RestResponse&lt;OrderHistoryListResponse, Object&gt; response = responseMapper.toDto(</b>
&nbsp;                    true,
&nbsp;                    &quot;FETCH ORDER HISTORY SUCCESSFULLY&quot;,
&nbsp;                    orderHistoryListResponse,
&nbsp;                    null
&nbsp;            );
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; [OrderController] created response successfully&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            return ResponseEntity.status(HttpStatus.OK.value()).body(response);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; Error at getOrdersHistoryOfCurrentUser: {}&quot;, e.getMessage());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @PreAuthorize(&quot;hasAnyRole(&#39;ROLE_BUYER&#39;, &#39;ROLE_SELLER&#39;)&quot;)
&nbsp;    @Operation(
&nbsp;            summary = &quot;Cancel an order&quot;,
&nbsp;            description = &quot;&quot;&quot;
&nbsp;                        Cancels an existing order for the currently authenticated user (buyer).  
&nbsp;                        This API updates the order status in the system and notifies the external GHN shipping service 
&nbsp;                        to cancel the corresponding shipment.
&nbsp;                    
&nbsp;                        **Workflow:**
&nbsp;                        1. The client sends a `POST` request with the order ID in the URL path.
&nbsp;                        2. The system validates that the order exists and belongs to the authenticated user.
&nbsp;                        3. The order status is updated to `CANCELED`.
&nbsp;                        4. The system calls the GHN shipping service API to cancel the shipping request.
&nbsp;                        5. The updated order information is returned in the response.
&nbsp;                    
&nbsp;                        **Use cases:**
&nbsp;                        - Buyers canceling an order before it is shipped.
&nbsp;                        - Sellers or system administrators canceling orders with failed payments or stock issues.
&nbsp;                        - Synchronizing order cancellations between internal system and GHN shipping API.
&nbsp;                    
&nbsp;                        **Security Notes:**
&nbsp;                        - Requires JWT authentication (either `ROLE_BUYER` or `ROLE_SELLER`).
&nbsp;                        - A user can only cancel orders they own.
&nbsp;                    &quot;&quot;&quot;
&nbsp;    )
&nbsp;    @PostMapping(&quot;/cancel/{id}&quot;)
&nbsp;    public ResponseEntity&lt;RestResponse&lt;OrderResponse, Object&gt;&gt; cancelOrder(
&nbsp;            @PathVariable Long id,
&nbsp;            @RequestBody CancelOrderRequest request
&nbsp;    ) throws Exception {
<b class="nc">&nbsp;        log.info(&quot;&gt;&gt;&gt; [OrderController] came cancelOrder&quot;);</b>
<b class="nc">&nbsp;        Order canceledOrder = orderService.cancelOrder(id, request);</b>
<b class="nc">&nbsp;        log.info(&quot;&gt;&gt;&gt; [OrderController] cancelOrder pass&quot;);</b>
<b class="nc">&nbsp;        systemWalletService.updateEscrowRecordStatus(canceledOrder.getSystemWallet(), SystemWalletStatus.REFUNDED);</b>
<b class="nc">&nbsp;        log.info(&quot;&gt;&gt;&gt; [OrderController] update system wallet status successfully&quot;);</b>
<b class="nc">&nbsp;        ghnService.createCancelOrderShippingServiceResponseToDto(canceledOrder.getOrderCode(), canceledOrder.getPostProduct().getSeller().getGhnShopId());</b>
<b class="nc">&nbsp;        log.info(&quot;&gt;&gt;&gt; [OrderController] cancel order ghn successfully&quot;);</b>
<b class="nc">&nbsp;        OrderResponse responseData = orderMapper.toDto(canceledOrder);</b>
<b class="nc">&nbsp;        log.info(&quot;&gt;&gt;&gt; [OrderController] created responseData successfully&quot;);</b>
<b class="nc">&nbsp;        RestResponse&lt;OrderResponse, Object&gt; response = responseMapper.toDto(</b>
&nbsp;                true,
&nbsp;                &quot;CANCELED ORDER SUCCESSFULLY&quot;,
&nbsp;                responseData,
&nbsp;                null
&nbsp;        );
<b class="nc">&nbsp;        log.info(&quot;&gt;&gt;&gt; [OrderController] created response successfully&quot;);</b>
<b class="nc">&nbsp;        return ResponseEntity.status(HttpStatus.OK.value()).body(response);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Operation(
&nbsp;            summary = &quot;Create a product review with optional images&quot;,
&nbsp;            description = &quot;&quot;&quot;
&nbsp;                    This endpoint allows customers to create a review for an electrical product they have purchased.
&nbsp;                    
&nbsp;                    The request should include:
&nbsp;                    - **Review details** (order ID, rating, feedback text) as a JSON object named `request`.
&nbsp;                    - **Optional product images** (photos of the product or proof of use) as `pictures`.
&nbsp;                    
&nbsp;                    The API automatically checks the feedback text for inappropriate or offensive language (Vietnamese supported).
&nbsp;                    Uploaded images will be stored on Cloudinary and associated with the review record.
&nbsp;                    
&nbsp;                    **Content type:** multipart/form-data  
&nbsp;                    **Authentication:** Required if the platform uses user accounts.
&nbsp;                    &quot;&quot;&quot;
&nbsp;    )
&nbsp;    @PreAuthorize(&quot;hasAnyRole(&#39;ROLE_BUYER&#39;, &#39;ROLE_SELLER&#39;)&quot;)
&nbsp;    @PostMapping(
&nbsp;            value = &quot;/review&quot;,
&nbsp;            consumes = MediaType.MULTIPART_FORM_DATA_VALUE
&nbsp;    )
&nbsp;    public ResponseEntity&lt;?&gt; createReview(@ModelAttribute ReviewRequest request,
&nbsp;                                          @RequestPart(name = &quot;pictures&quot;, required = false) List&lt;MultipartFile&gt; reviewImages) {
<b class="nc">&nbsp;        log.info(&quot;&gt;&gt;&gt; [Order Controller] Create Review: Started.&quot;);</b>
<b class="nc">&nbsp;        log.info(&quot;&gt;&gt;&gt; [Order Controller] Request: {}.&quot;, request);</b>
&nbsp;        try {
<b class="nc">&nbsp;            Review savedReview = reviewService.createReview(request, reviewImages);</b>
<b class="nc">&nbsp;            return ResponseEntity.ok(responseMapper.toDto(</b>
&nbsp;                    true,
&nbsp;                    &quot;MAKE REVIEW SUCCESSFULLY.&quot;,
<b class="nc">&nbsp;                    reviewMapper.toDto(savedReview), null));</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            return ResponseEntity.ok(responseMapper.toDto(</b>
&nbsp;                    true,
&nbsp;                    &quot;MAKE REVIEW FAILED.&quot;,
<b class="nc">&nbsp;                    null, e.getMessage()));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Operation(
&nbsp;            summary = &quot;Get all reviews by order ID&quot;,
&nbsp;            description = &quot;&quot;&quot;
&nbsp;                    This endpoint allows an authenticated user (buyer or seller) to retrieve all reviews 
&nbsp;                    associated with a specific order.
&nbsp;                    
&nbsp;                    - The `orderId` parameter must correspond to an existing order.
&nbsp;                    - Each review may include its rating, feedback text, and attached review images.
&nbsp;                    &quot;&quot;&quot;
&nbsp;    )
&nbsp;    @GetMapping(&quot;/get-review/{orderId}&quot;)
&nbsp;    public ResponseEntity&lt;?&gt; getReviewByOrderId(@PathVariable(name = &quot;orderId&quot;) long id) {
&nbsp;        try {
<b class="nc">&nbsp;            Review reviews = reviewService.getReviewsByOrderId(id);</b>
<b class="nc">&nbsp;            ReviewResponse response = reviewMapper.toDto(reviews);</b>
&nbsp;
<b class="nc">&nbsp;            return ResponseEntity.ok(responseMapper.toDto(</b>
&nbsp;                    true,
&nbsp;                    &quot;GET REVIEWS BY ORDER SUCCESSFULLY.&quot;,
&nbsp;                    response,
&nbsp;                    null
&nbsp;            ));
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            return ResponseEntity.ok(responseMapper.toDto(</b>
&nbsp;                    false,
&nbsp;                    &quot;GET REVIEWS BY ORDER FAILED.&quot;,
&nbsp;                    null,
<b class="nc">&nbsp;                    e.getMessage()</b>
&nbsp;            ));
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Operation(
&nbsp;            summary = &quot;Get payment information by order ID&quot;,
&nbsp;            description = &quot;&quot;&quot;
&nbsp;                    This endpoint retrieves the payment details associated with a specific order. 
&nbsp;                    It returns the payment ID, description, and gateway name linked to that order.
&nbsp;                    If the order or transaction does not exist, an error message will be returned.
&nbsp;                    &quot;&quot;&quot;
&nbsp;    )
&nbsp;    @GetMapping(&quot;/payment/{orderId}&quot;)
&nbsp;    public ResponseEntity&lt;?&gt; getPayment(@PathVariable(name = &quot;orderId&quot;) long id) {
<b class="nc">&nbsp;        log.info(&quot;&gt;&gt;&gt; [Order Controller] Get payment: Started.&quot;);</b>
&nbsp;        try {
<b class="nc">&nbsp;            Transaction transaction = orderService.getTransactionByOrderId(id);</b>
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; [Order Controller] Get transaction: {}&quot;, transaction);</b>
<b class="nc">&nbsp;            Payment payment = transaction.getPayment();</b>
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; [Order Controller] Get payment: {}&quot;, payment);</b>
<b class="nc">&nbsp;            Map&lt;String, Object&gt; data = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;            data.put(&quot;id&quot;, payment.getId());</b>
<b class="nc">&nbsp;            data.put(&quot;description&quot;, payment.getDescription());</b>
<b class="nc">&nbsp;            data.put(&quot;gatewayName&quot;, payment.getGatewayName());</b>
<b class="nc">&nbsp;            return ResponseEntity.ok(responseMapper.toDto(</b>
&nbsp;                    true,
&nbsp;                    &quot;GET ORDER PAYMENT SUCCESSFULLY.&quot;,
&nbsp;                    data, null
&nbsp;            ));
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            return ResponseEntity.ok(responseMapper.toDto(</b>
&nbsp;                    false,
&nbsp;                    &quot;GET ORDER PAYMENT FAILED.&quot;,
<b class="nc">&nbsp;                    null, e.getMessage()</b>
&nbsp;            ));
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @GetMapping(&quot;/{orderId}&quot;)
&nbsp;    public ResponseEntity&lt;RestResponse&lt;Map&lt;String, Object&gt;, Object&gt;&gt; getOrderDetailByOrderId(@PathVariable Long orderId) {
<b class="nc">&nbsp;        Order foundOrder = orderService.getOrderById(orderId);</b>
<b class="nc">&nbsp;        if (foundOrder == null) {</b>
<b class="nc">&nbsp;            throw new OrderNotFound();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        OrderResponse orderResponse = orderMapper.toDto(foundOrder);</b>
<b class="nc">&nbsp;        PaymentResponse paymentResponse = paymentMapper.toDto(foundOrder.getTransactions().getLast().getPayment());</b>
<b class="nc">&nbsp;        ShippingPartnerResponse shippingPartnerResponse = shippingPartnerMapper.toDto(foundOrder.getShippingPartner());</b>
<b class="nc">&nbsp;        PostProductResponse productResponse = postProductMapper.toDto(foundOrder.getPostProduct());</b>
<b class="nc">&nbsp;        BuyerResponse buyerResponse = buyerMapper.toDto(foundOrder.getBuyer());</b>
&nbsp;
&nbsp;
<b class="nc">&nbsp;        Map&lt;String, Object&gt; responseData = Map.of(</b>
&nbsp;                &quot;order&quot;, orderResponse,
&nbsp;                &quot;product&quot;, productResponse,
&nbsp;                &quot;buyer&quot;, buyerResponse,
&nbsp;                &quot;payment&quot;, paymentResponse,
&nbsp;                &quot;shippingPartner&quot;, shippingPartnerResponse
&nbsp;        );
&nbsp;
<b class="nc">&nbsp;        RestResponse&lt;Map&lt;String, Object&gt;, Object&gt; response = responseMapper.toDto(</b>
&nbsp;                true,
&nbsp;                &quot;FETCH ORDER DETAIL SUCCESSFULLY&quot;,
&nbsp;                responseData,
&nbsp;                null
&nbsp;        );
<b class="nc">&nbsp;        return ResponseEntity.status(HttpStatus.OK.value()).body(response);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Operation(
&nbsp;            summary = &quot;Get all orders of current seller&quot;,
&nbsp;            description = &quot;&quot;&quot;
&nbsp;                    Retrieve all orders associated with the current logged-in seller.
&nbsp;                    The result is paginated using &#39;page&#39; and &#39;size&#39; query parameters.
&nbsp;                    
&nbsp;                    Requirements:
&nbsp;                    - User must have ROLE_SELLER
&nbsp;                    - Authorization header with a valid JWT token is required
&nbsp;                    
&nbsp;                    Example:
&nbsp;                    GET /api/orders?page=0&amp;size=10
&nbsp;                    &quot;&quot;&quot;
&nbsp;    )
&nbsp;    @PreAuthorize(&quot;hasRole(&#39;ROLE_SELLER&#39;)&quot;)
&nbsp;    @GetMapping(&quot;&quot;)
&nbsp;    public ResponseEntity&lt;?&gt; getAllOrders(
&nbsp;            @RequestParam(name = &quot;page&quot;, defaultValue = &quot;0&quot;) int page,
&nbsp;            @RequestParam(name = &quot;size&quot;, defaultValue = &quot;10&quot;) int size
&nbsp;    ) {
&nbsp;        try {
<b class="nc">&nbsp;            Seller seller = buyerService.getCurrentUser().getSeller();</b>
<b class="nc">&nbsp;            Page&lt;Order&gt; orders = orderService.getAllOrders(page, size, seller);</b>
<b class="nc">&nbsp;            Page&lt;OrderResponse&gt; orderResponses = orders.map(orderMapper::toDto);</b>
<b class="nc">&nbsp;            return ResponseEntity.ok(responseMapper.toDto(</b>
&nbsp;                    true,
&nbsp;                    &quot;GET ALL ORDER SUCCESSFULLY.&quot;,
&nbsp;                    orderResponses, null
&nbsp;            ));
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            return ResponseEntity.ok(responseMapper.toDto(</b>
&nbsp;                    true,
&nbsp;                    &quot;GET ALL ORDER FAILED.&quot;,
<b class="nc">&nbsp;                    null, e.getMessage()</b>
&nbsp;            ));
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-11-06 20:39</div>
</div>
</body>
</html>
