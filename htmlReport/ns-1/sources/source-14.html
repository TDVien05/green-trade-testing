


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > PostProductServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">Green_trade.green_trade_platform.service.implement</a>
</div>

<h1>Coverage Summary for Class: PostProductServiceImpl (Green_trade.green_trade_platform.service.implement)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PostProductServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    65.2%
  </span>
  <span class="absValue">
    (15/23)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    70%
  </span>
  <span class="absValue">
    (21/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    80.3%
  </span>
  <span class="absValue">
    (143/178)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package Green_trade.green_trade_platform.service.implement;
&nbsp;
&nbsp;import Green_trade.green_trade_platform.enumerate.SellerStatus;
&nbsp;import Green_trade.green_trade_platform.enumerate.VerifiedDecisionStatus;
&nbsp;import Green_trade.green_trade_platform.exception.*;
&nbsp;import Green_trade.green_trade_platform.model.*;
&nbsp;import Green_trade.green_trade_platform.repository.*;
&nbsp;import Green_trade.green_trade_platform.request.PostProductDecisionRequest;
&nbsp;import Green_trade.green_trade_platform.request.UpdatePostProductRequest;
&nbsp;import Green_trade.green_trade_platform.request.UploadPostProductRequest;
&nbsp;import Green_trade.green_trade_platform.request.VerifiedPostProductRequest;
&nbsp;import Green_trade.green_trade_platform.response.SellerResponse;
&nbsp;import Green_trade.green_trade_platform.service.PostProductService;
&nbsp;import Green_trade.green_trade_platform.util.FileUtils;
&nbsp;import jakarta.persistence.EntityNotFoundException;
&nbsp;import jakarta.transaction.Transactional;
&nbsp;import lombok.AllArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.data.domain.*;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.web.multipart.MultipartFile;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@AllArgsConstructor
&nbsp;public class PostProductServiceImpl implements PostProductService {
&nbsp;
&nbsp;    private final PostProductRepository postProductRepository;
&nbsp;    private final CategoryRepository categoryRepository;
&nbsp;    private final AdminServiceImpl adminService;
&nbsp;    private final FileUtils fileUtils;
&nbsp;    private final CloudinaryService cloudinaryService;
&nbsp;    private final SellerRepository sellerRepository;
&nbsp;    private final ProductImageRepository productImageRepository;
&nbsp;    private final SubscriptionRepository subscriptionRepository;
&nbsp;    private final BuyerRepository buyerRepository;
&nbsp;    private final AdminRepository adminRepository;
&nbsp;    private final SubscriptionServiceImpl subscriptionService;
&nbsp;    private final WishListingRepository wishListingRepository;
&nbsp;
&nbsp;    public PostProduct createNewPostProduct(
&nbsp;            UploadPostProductRequest request,
&nbsp;            List&lt;MultipartFile&gt; files
&nbsp;    ) throws Exception {
&nbsp;        try {
<b class="fc">&nbsp;            Subscription subscription = subscriptionRepository.findFirstBySeller_SellerIdOrderByEndDayDesc(</b>
<b class="fc">&nbsp;                    request.getSellerId()).orElseThrow(() -&gt; new SubscriptionNotFound()</b>
&nbsp;            );
<b class="fc">&nbsp;            Long maxImg = subscription.getSubscriptionPackage().getMaxImgPerPost();</b>
<b class="fc">&nbsp;            if (subscription.getEndDay().isBefore(LocalDateTime.now())) {</b>
<b class="fc">&nbsp;                throw new SubscriptionExpiredException();</b>
&nbsp;            }
<b class="fc">&nbsp;            if (files.size() &gt; maxImg) {</b>
<b class="fc">&nbsp;                throw new ImageUploadLimitExceededException(&quot;Your subscription only allowed &quot; + maxImg + &quot;per post&quot;);</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            Category category = categoryRepository.findById(request.getCategoryId())</b>
<b class="fc">&nbsp;                    .orElseThrow(</b>
<b class="nc">&nbsp;                            () -&gt; new RuntimeException(&quot;Category is not existed&quot;)</b>
&nbsp;                    );
&nbsp;
<b class="fc">&nbsp;            Seller seller = sellerRepository.findById(request.getSellerId())</b>
<b class="fc">&nbsp;                    .orElseThrow(</b>
<b class="nc">&nbsp;                            () -&gt; new ProfileException(&quot;Seller is not existed&quot;)</b>
&nbsp;                    );
&nbsp;
<b class="fc">&nbsp;            PostProduct newPost = PostProduct.builder()</b>
<b class="fc">&nbsp;                    .seller(seller)</b>
<b class="fc">&nbsp;                    .title(request.getTitle())</b>
<b class="fc">&nbsp;                    .brand(request.getBrand())</b>
<b class="fc">&nbsp;                    .model(request.getModel())</b>
<b class="fc">&nbsp;                    .manufactureYear((request.getManufactureYear()))</b>
<b class="fc">&nbsp;                    .usedDuration(request.getUsedDuration())</b>
<b class="fc">&nbsp;                    .rejectedReason(&quot;No decision yet&quot;)</b>
<b class="fc">&nbsp;                    .conditionLevel(request.getConditionLevel())</b>
<b class="fc">&nbsp;                    .price(request.getPrice())</b>
<b class="fc">&nbsp;                    .length(request.getLength())</b>
<b class="fc">&nbsp;                    .width(request.getWidth())</b>
<b class="fc">&nbsp;                    .height(request.getHeight())</b>
<b class="fc">&nbsp;                    .weight(request.getWeight())</b>
<b class="fc">&nbsp;                    .description(request.getDescription())</b>
<b class="fc">&nbsp;                    .locationTrading(request.getLocationTrading())</b>
<b class="fc">&nbsp;                    .active(true)</b>
<b class="fc">&nbsp;                    .verifiedDecisionstatus(VerifiedDecisionStatus.UNVAILABLE)</b>
<b class="fc">&nbsp;                    .verified(false)</b>
<b class="fc">&nbsp;                    .createdAt(LocalDateTime.now())</b>
<b class="fc">&nbsp;                    .updatedAt(LocalDateTime.now())</b>
<b class="fc">&nbsp;                    .deletedAt(null)</b>
<b class="fc">&nbsp;                    .category(category)</b>
<b class="fc">&nbsp;                    .admin(null)</b>
<b class="fc">&nbsp;                    .build();</b>
<b class="fc">&nbsp;            log.info(&quot;&gt;&gt;&gt; request data: {}&quot;, request.toString());</b>
<b class="fc">&nbsp;            log.info(&quot;&gt;&gt;&gt; files data: {}&quot;, files);</b>
<b class="fc">&nbsp;            files.forEach((file) -&gt; {</b>
<b class="fc">&nbsp;                fileUtils.validateFile(file);</b>
<b class="fc">&nbsp;                log.info(&quot;&gt;&gt;&gt; Checked File name: {}&quot;, file.toString());</b>
&nbsp;            });
<b class="fc">&nbsp;            newPost = postProductRepository.save(newPost);</b>
&nbsp;
<b class="fc">&nbsp;            for (int i = 0; i &lt;= files.size() - 1; i++) {</b>
<b class="fc">&nbsp;                Map&lt;String, String&gt; uploadResult = cloudinaryService.upload(files.get(i), &quot;PostImages/&quot; + newPost.getId() + &quot;:&quot; + seller.getBuyer().getUsername() + &quot;/product_image_&quot; + i);</b>
<b class="fc">&nbsp;                String imageUrl = uploadResult.get(&quot;fileUrl&quot;);</b>
<b class="fc">&nbsp;                String publicId = uploadResult.get(&quot;publicId&quot;);</b>
<b class="fc">&nbsp;                log.info(&quot;&gt;&gt;&gt; Passed uploaded picture {}&quot;, i);</b>
<b class="fc">&nbsp;                ProductImage productImage = ProductImage.builder()</b>
<b class="fc">&nbsp;                        .imageUrl(imageUrl)</b>
<b class="fc">&nbsp;                        .orderImage((long) i + 1)</b>
<b class="fc">&nbsp;                        .postProduct(newPost)</b>
<b class="fc">&nbsp;                        .build();</b>
<b class="fc">&nbsp;                productImageRepository.save(productImage);</b>
&nbsp;            }
<b class="fc">&nbsp;            log.info(&quot;&gt;&gt;&gt; Passed uploaded file&quot;);</b>
&nbsp;
<b class="fc">&nbsp;            return newPost;</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.info(&quot;&gt;&gt;&gt; Error at createNewPostProduct: {}&quot;, e.getMessage());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public PostProduct uploadPostProductPicture(Long id, List&lt;MultipartFile&gt; files) throws Exception {
&nbsp;        try {
<b class="fc">&nbsp;            List&lt;PostProduct&gt; postProducts = postProductRepository.findAll();</b>
<b class="fc">&nbsp;            PostProduct newPost = postProductRepository.findById(id)</b>
<b class="fc">&nbsp;                    .orElseThrow(() -&gt; new ProfileException(&quot;Post Product is not existed&quot;));</b>
<b class="nc">&nbsp;            postProducts.forEach((postProduct) -&gt; {</b>
<b class="nc">&nbsp;                for (int i = 0; i &lt;= files.size() - 1; i++) {</b>
&nbsp;                    try {
<b class="nc">&nbsp;                        Map&lt;String, String&gt; uploadResult = cloudinaryService.upload(</b>
<b class="nc">&nbsp;                                files.get(i),</b>
<b class="nc">&nbsp;                                &quot;PostImages/&quot; + postProduct.getId() + &quot;:&quot; +</b>
<b class="nc">&nbsp;                                        postProduct.getSeller().getBuyer().getUsername() + &quot;/product_image_&quot; + i</b>
&nbsp;                        );
<b class="nc">&nbsp;                        String imageUrl = uploadResult.get(&quot;fileUrl&quot;);</b>
<b class="nc">&nbsp;                        ProductImage productImage = ProductImage.builder()</b>
<b class="nc">&nbsp;                                .imageUrl(imageUrl)</b>
<b class="nc">&nbsp;                                .orderImage((long) i + 1)</b>
<b class="nc">&nbsp;                                .postProduct(postProduct)</b>
<b class="nc">&nbsp;                                .build();</b>
<b class="nc">&nbsp;                        productImageRepository.save(productImage);</b>
&nbsp;                    } catch (Exception e) {
<b class="nc">&nbsp;                        throw new RuntimeException(e);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            });
<b class="nc">&nbsp;            return newPost;</b>
&nbsp;        } catch (Exception e) {
<b class="fc">&nbsp;            log.info(&quot;&gt;&gt;&gt; Error at createNewPostProduct: {}&quot;, e.getMessage());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    public Page&lt;PostProduct&gt; getAllProductPaging(int page, int size, String sortedBy, boolean isAsc) {
<b class="fc">&nbsp;        Pageable pageable = PageRequest.of(page, size, Sort.by(sortedBy).descending());</b>
<b class="pc">&nbsp;        if (!isAsc) {</b>
<b class="fc">&nbsp;            pageable = PageRequest.of(page, size, Sort.by(sortedBy).descending());</b>
&nbsp;        }
<b class="fc">&nbsp;        Page&lt;PostProduct&gt; postProductsPaging = postProductRepository.findAllBySoldFalseAndActiveTrue(pageable);</b>
<b class="fc">&nbsp;        return new PageImpl&lt;&gt;(</b>
<b class="fc">&nbsp;                postProductsPaging.getContent(),</b>
&nbsp;                pageable,
<b class="fc">&nbsp;                postProductsPaging.getTotalElements()</b>
&nbsp;        );
&nbsp;    }
&nbsp;
&nbsp;    public Page&lt;PostProduct&gt; getAllPostProductForVerifiedReview(int size, int page) throws Exception {
&nbsp;        try {
<b class="nc">&nbsp;            Pageable pageable = PageRequest.of(page, size, Sort.by(&quot;id&quot;).ascending());</b>
&nbsp;//            Page&lt;PostProduct&gt; postProductsPaging = postProductRepository.findAll(pageable);
&nbsp;//            List&lt;PostProduct&gt; postProducts = postProductsPaging.getContent();
&nbsp;//            List&lt;PostProduct&gt; result = new ArrayList&lt;&gt;();
&nbsp;//            for (int i = 0; i &lt;= postProducts.size() - 1; i++) {
&nbsp;//                PostProduct postProduct = postProducts.get(i);
&nbsp;//                Subscription subscription = subscriptionRepository.findFirstBySeller_SellerIdOrderByEndDayDesc(postProduct.getSeller().getSellerId()).orElseThrow(() -&gt; new Exception(&quot;Seller doesn&#39;t subscribe service&quot;));
&nbsp;//                log.info(&quot;&gt;&gt;&gt; subscription package id: {}&quot;, subscription.getSubscriptionPackage().getId());
&nbsp;//                log.info(&quot;&gt;&gt;&gt; postProduct verified status: {}&quot;, postProduct.getVerifiedDecisionstatus().toString());
&nbsp;//                if (subscription.getSubscriptionPackage().getId() &gt;= 2 &amp;&amp; postProduct.getVerifiedDecisionstatus().equals(VerifiedDecisionStatus.PENDING)) {
&nbsp;//                    log.info(&quot;&gt;&gt;&gt; result add: {} and {}&quot;, postProduct.getVerifiedDecisionstatus(), subscription.getSubscriptionPackage().getId());
&nbsp;//                    result.add(postProduct);
&nbsp;//                }
&nbsp;//            }
&nbsp;//            return new PageImpl&lt;&gt;(result, pageable, result.size());
<b class="nc">&nbsp;            return postProductRepository.findAllByVerifiedDecisionstatus(VerifiedDecisionStatus.PENDING, pageable);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; Error at PostProductServiceImpl: {}&quot;, e.getMessage());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public PostProduct getPostProductById(Long postProductId) throws Exception {
&nbsp;        try {
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; [Post Product Service] 2 Find post product by id: Started.&quot;);</b>
<b class="nc">&nbsp;            PostProduct foundPostProduct = postProductRepository.findById(postProductId).orElseThrow(</b>
<b class="nc">&nbsp;                    () -&gt; new PostProductNotFound()</b>
&nbsp;            );
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; [Post Product Service] 2 Post product info: {}&quot;, foundPostProduct);</b>
<b class="nc">&nbsp;            return foundPostProduct;</b>
&nbsp;        } catch (Exception e) {
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public PostProduct checkPostProductVerification(PostProductDecisionRequest request) throws Exception {
&nbsp;        try {
<b class="fc">&nbsp;            log.info(&quot;&gt;&gt;&gt; request: {}&quot;, request);</b>
<b class="fc">&nbsp;            Admin admin = adminService.getCurrentUser();</b>
<b class="fc">&nbsp;            log.info(&quot;&gt;&gt;&gt; admin id: {}&quot;, admin.getId());</b>
<b class="fc">&nbsp;            PostProduct postProduct = postProductRepository.findById(</b>
<b class="fc">&nbsp;                    request.getPostProductId()).orElseThrow(() -&gt; new PostProductNotFound()</b>
&nbsp;            );
&nbsp;
<b class="pc">&nbsp;            if (!request.getPassed()) {</b>
<b class="nc">&nbsp;                postProduct.setVerifiedDecisionstatus(VerifiedDecisionStatus.REJECTED);</b>
<b class="nc">&nbsp;                postProduct.setVerified(false);</b>
<b class="nc">&nbsp;                postProduct.setAdmin(admin);</b>
<b class="nc">&nbsp;                postProduct.setRejectedReason(request.getRejectedReason());</b>
&nbsp;            } else {
<b class="fc">&nbsp;                postProduct.setVerifiedDecisionstatus(VerifiedDecisionStatus.APPROVED);</b>
<b class="fc">&nbsp;                postProduct.setVerified(true);</b>
<b class="fc">&nbsp;                postProduct.setAdmin(admin);</b>
<b class="fc">&nbsp;                postProduct.setRejectedReason(&quot;&quot;);</b>
&nbsp;            }
<b class="fc">&nbsp;            postProductRepository.save(postProduct);</b>
&nbsp;
<b class="fc">&nbsp;            return postProductRepository.save(postProduct);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; Error at decidePostContentValidation: {}&quot;, e.getMessage());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public PostProduct postProductVerifiedRequest(VerifiedPostProductRequest request) throws Exception {
<b class="fc">&nbsp;        PostProduct postProduct = postProductRepository.findById(request.getPostId()).orElseThrow(() -&gt; new Exception(&quot;Post is not existed&quot;));</b>
<b class="fc">&nbsp;        Long sellerId = postProduct.getSeller().getSellerId();</b>
<b class="fc">&nbsp;        if (subscriptionService.isServicePackageExpired(sellerId)) {</b>
<b class="fc">&nbsp;            throw new SubscriptionExpiredException();</b>
&nbsp;        }
<b class="fc">&nbsp;        postProduct.setVerifiedDecisionstatus(VerifiedDecisionStatus.PENDING);</b>
<b class="fc">&nbsp;        return postProductRepository.save(postProduct);</b>
&nbsp;    }
&nbsp;
&nbsp;    public PostProduct updateSoldStatus(boolean status, PostProduct postProduct) {
<b class="fc">&nbsp;        postProduct.setSold(status);</b>
<b class="fc">&nbsp;        return postProductRepository.save(postProduct);</b>
&nbsp;    }
&nbsp;
&nbsp;    public PostProduct findPostProductById(Long id) {
<b class="fc">&nbsp;        log.info(&quot;&gt;&gt;&gt; [Post Product Service] Find post product by id: Started.&quot;);</b>
<b class="fc">&nbsp;        PostProduct foundPostProduct = null;</b>
<b class="fc">&nbsp;        Optional&lt;PostProduct&gt; postProductOpt = postProductRepository.findById(id);</b>
<b class="fc">&nbsp;        if (postProductOpt.isPresent()) {</b>
<b class="fc">&nbsp;            foundPostProduct = postProductOpt.get();</b>
&nbsp;        }
<b class="fc">&nbsp;        log.info(&quot;&gt;&gt;&gt; [Post Product Service] Post product info: {}&quot;, foundPostProduct);</b>
<b class="fc">&nbsp;        return foundPostProduct;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Page&lt;PostProduct&gt; getAllPostBySeller(Seller seller, int page, int size) {
<b class="fc">&nbsp;        Pageable pageable = PageRequest.of(page, size, Sort.by(&quot;createdAt&quot;).descending());</b>
<b class="fc">&nbsp;        return postProductRepository.findBySeller(seller, pageable);</b>
&nbsp;    }
&nbsp;
&nbsp;    public PostProduct hidePostProduct(Long id, boolean isHide) {
<b class="fc">&nbsp;        PostProduct selected = postProductRepository.findById(id).orElseThrow(</b>
<b class="fc">&nbsp;                () -&gt; new IllegalArgumentException(&quot;Post product id does not existed.&quot;)</b>
&nbsp;        );
&nbsp;
<b class="fc">&nbsp;        selected.setActive(!isHide);</b>
<b class="fc">&nbsp;        return postProductRepository.save(selected);</b>
&nbsp;    }
&nbsp;
&nbsp;    public PostProduct findPostByWishId(long id) {
<b class="fc">&nbsp;        return wishListingRepository.findPostProductByWishListId(id).orElseThrow(</b>
<b class="fc">&nbsp;                () -&gt; new IllegalArgumentException(&quot;Can not find post product with this wish-list id: &quot; + id)</b>
&nbsp;        );
&nbsp;    }
&nbsp;
&nbsp;    public PostProduct updatePostProduct(
&nbsp;            PostProduct postProduct,
&nbsp;            UpdatePostProductRequest request,
&nbsp;            List&lt;MultipartFile&gt; files
&nbsp;    ) throws Exception {
&nbsp;        try {
<b class="fc">&nbsp;            postProduct.setTitle(request.getTitle());</b>
<b class="fc">&nbsp;            postProduct.setBrand(request.getBrand());</b>
<b class="fc">&nbsp;            postProduct.setModel(request.getModel());</b>
<b class="fc">&nbsp;            postProduct.setManufactureYear(request.getManufactureYear());</b>
<b class="fc">&nbsp;            postProduct.setUsedDuration(request.getUsedDuration());</b>
<b class="fc">&nbsp;            postProduct.setConditionLevel(request.getConditionLevel());</b>
<b class="fc">&nbsp;            postProduct.setPrice(request.getPrice());</b>
<b class="fc">&nbsp;            postProduct.setWidth(request.getWidth());</b>
<b class="fc">&nbsp;            postProduct.setHeight(request.getHeight());</b>
<b class="fc">&nbsp;            postProduct.setLength((request.getLength()));</b>
<b class="fc">&nbsp;            postProduct.setWeight(request.getWeight());</b>
<b class="fc">&nbsp;            postProduct.setDescription(request.getDescription());</b>
<b class="fc">&nbsp;            postProduct.setLocationTrading(request.getLocationTrading());</b>
&nbsp;
&nbsp;
<b class="fc">&nbsp;            postProduct.setVerified(false);</b>
<b class="fc">&nbsp;            postProduct.setVerifiedDecisionstatus(VerifiedDecisionStatus.PENDING);</b>
&nbsp;
<b class="fc">&nbsp;            List&lt;ProductImage&gt; productImages = productImageRepository.findAllByPostProduct(postProduct);</b>
&nbsp;
<b class="fc">&nbsp;            for (int i = 0; i &lt;= productImages.size() - 1; i++) {</b>
<b class="fc">&nbsp;                String imagePublicId = productImages.get(i).getImagePublicId();</b>
<b class="fc">&nbsp;                String folder = &quot;PostImages/&quot; + postProduct.getId() + &quot;:&quot; + postProduct.getSeller().getBuyer().getUsername() + &quot;/product_image_&quot; + i;</b>
<b class="pc">&nbsp;                if (</b>
<b class="pc">&nbsp;                        (!(imagePublicId == null)) &amp;&amp; (!imagePublicId.equalsIgnoreCase(&quot;&quot;))</b>
&nbsp;                ) {
<b class="fc">&nbsp;                    boolean isDeleted = cloudinaryService.delete(imagePublicId, folder);</b>
&nbsp;
<b class="pc">&nbsp;                    if (!isDeleted) {</b>
<b class="nc">&nbsp;                        throw new Exception(&quot;Delete product image failed&quot;);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            productImageRepository.deleteAllInBatch(productImages);</b>
&nbsp;
<b class="pc">&nbsp;            if (files != null &amp;&amp; files.size() &gt; 0) {</b>
<b class="fc">&nbsp;                log.info(&quot;&gt;&gt;&gt; files data: {}&quot;, files);</b>
&nbsp;//                files.forEach((file) -&gt; {
&nbsp;//                    fileUtils.validateFile(file);
&nbsp;//                    log.info(&quot;&gt;&gt;&gt; Checked File name: {}&quot;, file.toString());
&nbsp;//                });
&nbsp;
<b class="fc">&nbsp;                for (int i = 0; i &lt;= files.size() - 1; i++) {</b>
<b class="fc">&nbsp;                    Map&lt;String, String&gt; uploadResult = cloudinaryService.upload(files.get(i), &quot;PostImages/&quot; + postProduct.getId() + &quot;:&quot; + postProduct.getSeller().getBuyer().getUsername() + &quot;/product_image_&quot; + i);</b>
<b class="fc">&nbsp;                    String imageUrl = uploadResult.get(&quot;fileUrl&quot;);</b>
<b class="fc">&nbsp;                    String imagePublicId = uploadResult.get(&quot;publicId&quot;);</b>
<b class="fc">&nbsp;                    log.info(&quot;&gt;&gt;&gt; Passed uploaded picture {}&quot;, i);</b>
<b class="fc">&nbsp;                    ProductImage productImage = ProductImage.builder()</b>
<b class="fc">&nbsp;                            .imageUrl(imageUrl)</b>
<b class="fc">&nbsp;                            .imagePublicId(imagePublicId)</b>
<b class="fc">&nbsp;                            .orderImage((long) i + 1)</b>
<b class="fc">&nbsp;                            .postProduct(postProduct)</b>
<b class="fc">&nbsp;                            .build();</b>
<b class="fc">&nbsp;                    productImageRepository.save(productImage);</b>
&nbsp;                }
<b class="fc">&nbsp;                log.info(&quot;&gt;&gt;&gt; Passed uploaded file&quot;);</b>
&nbsp;            }
<b class="fc">&nbsp;            return postProductRepository.save(postProduct);</b>
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.info(&quot;&gt;&gt;&gt; [PostProductServiceImpl] error at updatePostProduct: {}&quot;, e.getMessage());</b>
&nbsp;            throw e;
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public Seller findSellerByPostId(Long id) {
<b class="nc">&nbsp;        PostProduct postProduct = postProductRepository.findById(id).orElseThrow(</b>
<b class="nc">&nbsp;                () -&gt; new EntityNotFoundException(&quot;Can not find post product with id: &quot; + id)</b>
&nbsp;        );
<b class="nc">&nbsp;        return postProduct.getSeller();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-11-07 21:16</div>
</div>
</body>
</html>
